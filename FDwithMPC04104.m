tic%è®¡æ—¶å¼?§‹
%ç¬¬äºŒè‰²åˆ°ç¬¬ä¸ƒè‰? ç©¿æ–™é•¿åº¦ä¸ç›¸ç­‰çš„æƒ…å†µ
clear;clc;
% close all;

L1=6.56;%ç©¿æ–™é•¿åº¦ï¼ˆmï¼?
L2=7.08;
L3=6.08;
L4=7.91;
L5=7.33;
L6=6.89;

C=0.68;%å°åˆ·ç‰ˆè¾Šå‘¨é•¿ï¼ˆmï¼?r=0.1083(m)
V=100/60;%å°åˆ·é€Ÿåº¦ï¼ˆm/sï¼?

a1=V/L1;a2=V/L2;a3=V/L3;a4=V/L4;a5=V/L5;a6=V/L6;%(1/s)

Ts=C/V;%é‡‡æ ·å‘¨æœŸï¼ˆsï¼?

Nr1=round(L1/C);Nr2=round(L2/C);Nr3=round(L3/C);%
Nr4=round(L4/C);Nr5=round(L5/C);Nr6=round(L6/C);

r=C/(3.14159*2);%å°åˆ·ç‰ˆè¾ŠåŠå¾„(m)
%çº¿æ?ç³»ç»Ÿç³»æ•°
A=[1-1/Nr1 0 0 0 0 0;
   0 1-1/Nr2 0 0 0 0;
   0 0 1-1/Nr3 0 0 0;
   0 0 0 1-1/Nr4 0 0;
   0 0 0 0 1-1/Nr5 0;
   0 0 0 0 0 1-1/Nr6];
B=[r/Nr1 0 0 0 0 0;
   0 r/Nr2 0 0 0 0;
   0 0 r/Nr3 0 0 0;
   0 0 0 r/Nr4 0 0;
   0 0 0 0 r/Nr5 0;
   0 0 0 0 0 r/Nr6];
%åˆå§‹è¯¯å·®é‡?
e0=[300;0;0;0;0;0];%0.01mm
%é¢„æµ‹æ­¥é•¿
Np=5;
%ä¼˜åŒ–ç›®æ ‡å‚æ•°ï¼ŒåŠ æƒçŸ©é˜?
Q=[1 0 0 0 0 0;
   0 1 0 0 0 0;  
   0 0 1 0 0 0;
   0 0 0 1 0 0;
   0 0 0 0 1 0;
   0 0 0 0 0 1];
R=[1 0 0 0 0 0;
   0 1 0 0 0 0;
   0 0 1 0 0 0;
   0 0 0 1 0 0;
   0 0 0 0 1 0;
   0 0 0 0 0 1];
%è½¬åŒ–ä¸ºç”¨æ§åˆ¶é‡utè¡¨ç¤ºçš„ï¼Œå…³äºè¯¯å·®é‡çš„æ¨å¯¼æ–¹ç¨‹çš„çŸ©é˜?
At=[];Bt=[];temp=[];
%è½¬æ¢åçš„åŠ æƒçŸ©é˜µ
Qt=[];Rt=[];


%ä¼ é?å‡½æ•°
G=tf([1],[1]);%å½“å‰è‰²ç»„è‡ªèº«MPCæ§åˆ¶é‡?
U=c2d(G,Ts);
G=tf([1,0],[1,a1]);%ç¬¬äºŒè‰²å¯¹åç»­è‰²ç»„çš„è§£è€¦è¡¥å¿ä¼ é€’å‡½æ•?
U2=c2d(G,Ts);
G=tf([1,0],[1,a2]);%ç¬¬ä¸‰è‰²å¯¹åç»­è‰²ç»„çš„è§£è€¦è¡¥å¿ä¼ é€’å‡½æ•?
U3=c2d(G,Ts);
G=tf([1,0],[1,a3]);%ç¬¬å››è‰²å¯¹åç»­è‰²ç»„çš„è§£è€¦è¡¥å¿ä¼ é€’å‡½æ•?
U4=c2d(G,Ts);
G=tf([1,0],[1,a4]);%ç¬¬äº”è‰²å¯¹åç»­è‰²ç»„çš„è§£è€¦è¡¥å¿ä¼ é€’å‡½æ•?
U5=c2d(G,Ts);
G=tf([1,0],[1,a5]);%ç¬¬å…­è‰²å¯¹åç»­è‰²ç»„çš„è§£è€¦è¡¥å¿ä¼ é€’å‡½æ•?
U6=c2d(G,Ts);

G=tf([a2*r],[1,a2]);%ç¬¬ä¸‰è‰²è¯¯å·?
G3=c2d(G,Ts);
G=tf([r*a1*a2],[1,a1+a2,a1*a2]);
G321=c2d(G,Ts);
G=tf([r*a2],[1,a2]);
G322=c2d(G,Ts);

G=tf([r*a3],[1,a3]);%ç¬¬å››è‰²è¯¯å·?
G4=c2d(G,Ts);
G=tf([r*a1*a2*a3],[1,a1+a2+a3,a1*a2+a1*a3+a2*a3,a1*a2*a3]);
G421=c2d(G,Ts);
G=tf([r*a2*a3],[1,a2+a3,a2*a3]);
G422=c2d(G,Ts);
G=tf([r*a2*a3],[1,a2+a3,a2*a3]);
G431=c2d(G,Ts);
G=tf([r*a3],[1,a3]);
G432=c2d(G,Ts);

G=tf([r*a4],[1,a4]);%ç¬¬äº”è‰²è¯¯å·?
G5=c2d(G,Ts);
G=tf([r*a1*a2*a3*a4],[1,a1+a2+a3+a4,a1*a2+a1*a3+a1*a4+a2*a3+a2*a4+a3*a4,a1*a2*a3+a1*a2*a4+a1*a3*a4+a2*a3*a4,a1*a2*a3*a4]);
G521=c2d(G,Ts);
G=tf([r*a2*a3*a4],[1,a2+a3+a4,a2*a3+a2*a4+a3*a4,a2*a3*a4]);
G522=c2d(G,Ts);
G=tf([r*a2*a3*a4],[1,a2+a3+a4,a2*a3+a2*a4+a3*a4,a2*a3*a4]);
G531=c2d(G,Ts);
G=tf([r*a3*a4],[1,a3+a4,a3*a4]);
G532=c2d(G,Ts);
G=tf([r*a3*a4],[1,a3+a4,a3*a4]);
G541=c2d(G,Ts);
G=tf([r*a4],[1,a4]);
G542=c2d(G,Ts);

G=tf([r*a5],[1,a5]);%ç¬¬å…­è‰²è¯¯å·?
G6=c2d(G,Ts);
G=tf([r*a1*a2*a3*a4*a5],[1,a1+a2+a3+a4+a5,a1*a2+a1*a3+a1*a4+a1*a5+a2*a3+a2*a4+a2*a5+a3*a4+a3*a5+a4*a5,a1*a2*a3+a1*a2*a4+a1*a2*a5+a1*a3*a4+a1*a3*a5+a1*a4*a5+a2*a3*a4+a2*a3*a5+a2*a4*a5+a3*a4*a5,a1*a2*a3*a4+a1*a2*a3*a5+a1*a2*a4*a5+a2*a3*a4*a5+a1*a3*a4*a5,a1*a2*a3*a4*a5]);
G621=c2d(G,Ts);
G=tf([r*a2*a3*a4*a5],[1,a2+a3+a4+a5,a2*a3+a2*a4+a2*a5+a3*a4+a3*a5+a4*a5,a2*a3*a4+a2*a3*a5+a2*a4*a5+a3*a4*a5,a2*a3*a4*a5]);
G622=c2d(G,Ts);
G=tf([r*a2*a3*a4*a5],[1,a2+a3+a4+a5,a2*a3+a2*a4+a2*a5+a3*a4+a3*a5+a4*a5,a2*a3*a4+a2*a3*a5+a2*a4*a5+a3*a4*a5,a2*a3*a4*a5]);
G631=c2d(G,Ts);
G=tf([r*a3*a4*a5],[1,a3+a4+a5,a3*a4+a3*a5+a4*a5,a3*a4*a5]);
G632=c2d(G,Ts);
G=tf([r*a3*a4*a5],[1,a3+a4+a5,a3*a4+a3*a5+a4*a5,a3*a4*a5]);
G641=c2d(G,Ts);
G=tf([r*a4*a5],[1,a4+a5,a4*a5]);
G642=c2d(G,Ts);
G=tf([r*a4*a5],[1,a4+a5,a4*a5]);
G651=c2d(G,Ts);
G=tf([r*a5],[1,a5]);
G652=c2d(G,Ts);

G=tf([r*a6],[1,a6]);%ç¬¬ä¸ƒè‰²è¯¯å·?
G7=c2d(G,Ts);
G=tf([r*a1*a2*a3*a4*a5*a6],[1,a1+a2+a3+a4+a5+a6,a1*a2+a1*a3+a1*a4+a1*a5+a1*a6+a2*a3+a2*a4+a2*a5+a2*a6+a3*a4+a3*a5+a3*a6+a4*a5+a4*a6+a5*a6,a1*a2*a3+a1*a2*a4+a1*a2*a5+a1*a2*a6+a1*a3*a4+a1*a3*a5+a1*a3*a6+a1*a4*a5+a1*a4*a6+a1*a5*a6+a2*a3*a4+a2*a3*a5+a2*a3*a6+a2*a4*a5+a2*a4*a6+a2*a5*a6+a3*a4*a5+a3*a4*a6+a3*a5*a6+a4*a5*a6,a1*a2*a3*a4+a1*a2*a3*a5+a1*a2*a3*a6+a1*a2*a4*a5+a1*a2*a4*a6+a1*a2*a5*a6+a1*a3*a4*a5+a1*a3*a4*a6+a1*a3*a5*a6+a1*a4*a5*a6+a2*a3*a4*a5+a2*a3*a4*a6+a2*a3*a5*a6+a2*a4*a5*a6+a3*a4*a5*a6,a1*a2*a3*a4*a5+a1*a2*a3*a4*a6+a1*a2*a3*a5*a6+a1*a2*a4*a5*a6+a1*a3*a4*a5*a6+a2*a3*a4*a5*a6,a1*a2*a3*a4*a5*a6]);
G721=c2d(G,Ts);
G=tf([r*a2*a3*a4*a5*a6],[1,a2+a3+a4+a5+a6,a2*a3+a2*a4+a2*a5+a2*a6+a3*a4+a3*a5+a3*a6+a4*a5+a4*a6+a5*a6,a2*a3*a4+a2*a3*a5+a2*a3*a6+a2*a4*a5+a2*a4*a6+a2*a5*a6+a3*a4*a5+a3*a4*a6+a3*a5*a6+a4*a5*a6,a2*a3*a4*a5+a2*a3*a4*a6+a2*a3*a5*a6+a2*a4*a5*a6+a3*a4*a5*a6,a2*a3*a4*a5*a6]);
G722=c2d(G,Ts);
G=tf([r*a2*a3*a4*a5*a6],[1,a2+a3+a4+a5+a6,a2*a3+a2*a4+a2*a5+a2*a6+a3*a4+a3*a5+a3*a6+a4*a5+a4*a6+a5*a6,a2*a3*a4+a2*a3*a5+a2*a3*a6+a2*a4*a5+a2*a4*a6+a2*a5*a6+a3*a4*a5+a3*a4*a6+a3*a5*a6+a4*a5*a6,a2*a3*a4*a5+a2*a3*a4*a6+a2*a3*a5*a6+a2*a4*a5*a6+a3*a4*a5*a6,a2*a3*a4*a5*a6]);
G731=c2d(G,Ts);
G=tf([r*a3*a4*a5*a6],[1,a3+a4+a5+a6,a3*a4+a3*a5+a3*a6+a4*a5+a4*a6+a5*a6,a3*a4*a5+a3*a4*a6+a3*a5*a6+a4*a5*a6,a3*a4*a5*a6]);
G732=c2d(G,Ts);
G=tf([r*a3*a4*a5*a6],[1,a3+a4+a5+a6,a3*a4+a3*a5+a3*a6+a4*a5+a4*a6+a5*a6,a3*a4*a5+a3*a4*a6+a3*a5*a6+a4*a5*a6,a3*a4*a5*a6]);
G741=c2d(G,Ts);
G=tf([r*a4*a5*a6],[1,a4+a5+a6,a4*a5+a4*a6+a5*a6,a4*a5*a6]);
G742=c2d(G,Ts);
G=tf([r*a4*a5*a6],[1,a4+a5+a6,a4*a5+a4*a6+a5*a6,a4*a5*a6]);
G751=c2d(G,Ts);
G=tf([r*a5*a6],[1,a5+a6,a5*a6]);
G752=c2d(G,Ts);
G=tf([r*a5*a6],[1,a5+a6,a5*a6]);
G761=c2d(G,Ts);
G=tf([r*a6],[1,a6]);
G762=c2d(G,Ts);


%åŠ æƒçŸ©é˜µçš„è®¡ç®—è¿‡ç¨‹ï¼Œä»¥åŠæ¨å¯¼æ–¹ç¨‹çŸ©é˜µçš„å åŠ è¿‡ç¨?
for i=1:Np
    At=[At;A^i];
    Bt=[Bt zeros(size(Bt,1),size(B,2));
        A^(i-1)*B temp];
    temp=[A^(i-1)*B temp];
    
    Qt=[Qt zeros(size(Qt,1),size(Q,1));
        zeros(size(Q,1),size(Qt,1)) Q];
    Rt=[Rt zeros(size(Rt,1),size(R,1));
        zeros(size(R,1),size(Rt,1)) R];
end
%æ§åˆ¶é‡utçš„åˆå§‹å?
u0=zeros(6*Np,1);%0.01mm
%è½¬æ¢åçš„ä¼˜åŒ–ç›®æ ‡å‡½æ•°ç³»æ•°çŸ©é˜µï¼Œå¾ªç¯ä¼˜åŒ–å‡½æ•°ä¸­Håçš„è¡¨è¾¾å¼ä¸ºä¼˜åŒ–ç›®æ ‡çš„å¦ä¸?¡¹
H=2*(Bt'*Qt*Bt+Rt);
u21(1:3)=0;%ç¬¬äºŒè‰²çš„MPCæ§åˆ¶é‡?
u2(1:3)=0;%ç¬¬äºŒè‰²çš„å®é™…æ§åˆ¶é‡?
u31(1:3)=0;%ç¬¬ä¸‰è‰²çš„MPCæ§åˆ¶é‡?
u3(1:3)=0;%ç¬¬ä¸‰è‰²çš„å®é™…æ§åˆ¶é‡?
u41(1:3)=0;%ç¬¬å››è‰²çš„MPCæ§åˆ¶é‡?
u4(1:3)=0;%ç¬¬å››è‰²çš„å®é™…æ§åˆ¶é‡?
u51(1:3)=0;%ç¬¬äº”è‰²çš„MPCæ§åˆ¶é‡?
u5(1:3)=0;%ç¬¬äº”è‰²çš„å®é™…æ§åˆ¶é‡?
u61(1:3)=0;%ç¬¬å…­è‰²çš„MPCæ§åˆ¶é‡?
u6(1:3)=0;%ç¬¬å…­è‰²çš„å®é™…æ§åˆ¶é‡?
u71(1:3)=0;%ç¬¬ä¸ƒè‰²çš„MPCæ§åˆ¶é‡?
u7(1:3)=0;%ç¬¬ä¸ƒè‰²çš„å®é™…æ§åˆ¶é‡?

u2b(1:3)=0;%å¯¹ç¬¬äºŒè‰²çš„è¡¥å¿é‡
u3b(1:3)=0;
u4b(1:3)=0;
u5b(1:3)=0;
u6b(1:3)=0;

w2(1:3)=0;%ç¬¬äºŒè‰²åŸæœ¬çš„MPCæ§åˆ¶é‡ï¼ˆä¸åŠ ç§¯åˆ†ï¼?
w3(1:3)=0;
w4(1:3)=0;
w5(1:3)=0;
w6(1:3)=0;
w7(1:3)=0;


e2(1:3)=e0(1,:);%ç¬¬äºŒè‰²å®é™…è¯¯å·?
e3(1:3,1)=e0(2,:);%ç¬¬ä¸‰è‰²å®é™…è¯¯å·?
e4(1:3,1)=e0(3,:);%ç¬¬å››è‰²å®é™…è¯¯å·?
e5(1:3,1)=e0(4,:);%ç¬¬äº”è‰²å®é™…è¯¯å·?
e6(1:3,1)=e0(5,:);%ç¬¬å…­è‰²å®é™…è¯¯å·?
e7(1:3,1)=e0(6,:);%ç¬¬ä¸ƒè‰²å®é™…è¯¯å·?
ek=e0;

for k = 3:200
    t = 0:Ts:Ts*(k-1);

% 3.æ ¹æ®æœ?¼˜æ§åˆ¶é‡åºåˆ—ç®€åŒ–å‡ºçš„å…¬å¼ï¼Œè®¡ç®—å‡ºut
    K1=r*(5*Nr1^9 - 25*Nr1^8 + 20*Nr1^7*r^2 + 70*Nr1^7 - 80*Nr1^6*r^2 - 130*Nr1^6 + 21*Nr1^5*r^4 + 162*Nr1^5*r^2 + 166*Nr1^5 - 63*Nr1^4*r^4 - 206*Nr1^4*r^2 - 148*Nr1^4 + 8*Nr1^3*r^6 + 87*Nr1^3*r^4 + 170*Nr1^3*r^2 + 91*Nr1^3 - 16*Nr1^2*r^6 - 69*Nr1^2*r^4 - 90*Nr1^2*r^2 - 37*Nr1^2 + Nr1*r^8 + 12*Nr1*r^6 + 30*Nr1*r^4 + 28*Nr1*r^2 + 9*Nr1 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr1^10 + 15*Nr1^8*r^2 - 40*Nr1^7*r^2 + 35*Nr1^6*r^4 + 80*Nr1^6*r^2 - 84*Nr1^5*r^4 - 108*Nr1^5*r^2 + 28*Nr1^4*r^6 + 126*Nr1^4*r^4 + 103*Nr1^4*r^2 - 48*Nr1^3*r^6 - 116*Nr1^3*r^4 - 68*Nr1^3*r^2 + 9*Nr1^2*r^8 + 48*Nr1^2*r^6 + 69*Nr1^2*r^4 + 30*Nr1^2*r^2 - 8*Nr1*r^8 - 24*Nr1*r^6 - 24*Nr1*r^4 - 8*Nr1*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
	K2=r*(5*Nr2^9 - 25*Nr2^8 + 20*Nr2^7*r^2 + 70*Nr2^7 - 80*Nr2^6*r^2 - 130*Nr2^6 + 21*Nr2^5*r^4 + 162*Nr2^5*r^2 + 166*Nr2^5 - 63*Nr2^4*r^4 - 206*Nr2^4*r^2 - 148*Nr2^4 + 8*Nr2^3*r^6 + 87*Nr2^3*r^4 + 170*Nr2^3*r^2 + 91*Nr2^3 - 16*Nr2^2*r^6 - 69*Nr2^2*r^4 - 90*Nr2^2*r^2 - 37*Nr2^2 + Nr2*r^8 + 12*Nr2*r^6 + 30*Nr2*r^4 + 28*Nr2*r^2 + 9*Nr2 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr2^10 + 15*Nr2^8*r^2 - 40*Nr2^7*r^2 + 35*Nr2^6*r^4 + 80*Nr2^6*r^2 - 84*Nr2^5*r^4 - 108*Nr2^5*r^2 + 28*Nr2^4*r^6 + 126*Nr2^4*r^4 + 103*Nr2^4*r^2 - 48*Nr2^3*r^6 - 116*Nr2^3*r^4 - 68*Nr2^3*r^2 + 9*Nr2^2*r^8 + 48*Nr2^2*r^6 + 69*Nr2^2*r^4 + 30*Nr2^2*r^2 - 8*Nr2*r^8 - 24*Nr2*r^6 - 24*Nr2*r^4 - 8*Nr2*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
	K3=r*(5*Nr3^9 - 25*Nr3^8 + 20*Nr3^7*r^2 + 70*Nr3^7 - 80*Nr3^6*r^2 - 130*Nr3^6 + 21*Nr3^5*r^4 + 162*Nr3^5*r^2 + 166*Nr3^5 - 63*Nr3^4*r^4 - 206*Nr3^4*r^2 - 148*Nr3^4 + 8*Nr3^3*r^6 + 87*Nr3^3*r^4 + 170*Nr3^3*r^2 + 91*Nr3^3 - 16*Nr3^2*r^6 - 69*Nr3^2*r^4 - 90*Nr3^2*r^2 - 37*Nr3^2 + Nr3*r^8 + 12*Nr3*r^6 + 30*Nr3*r^4 + 28*Nr3*r^2 + 9*Nr3 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr3^10 + 15*Nr3^8*r^2 - 40*Nr3^7*r^2 + 35*Nr3^6*r^4 + 80*Nr3^6*r^2 - 84*Nr3^5*r^4 - 108*Nr3^5*r^2 + 28*Nr3^4*r^6 + 126*Nr3^4*r^4 + 103*Nr3^4*r^2 - 48*Nr3^3*r^6 - 116*Nr3^3*r^4 - 68*Nr3^3*r^2 + 9*Nr3^2*r^8 + 48*Nr3^2*r^6 + 69*Nr3^2*r^4 + 30*Nr3^2*r^2 - 8*Nr3*r^8 - 24*Nr3*r^6 - 24*Nr3*r^4 - 8*Nr3*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
	K4=r*(5*Nr4^9 - 25*Nr4^8 + 20*Nr4^7*r^2 + 70*Nr4^7 - 80*Nr4^6*r^2 - 130*Nr4^6 + 21*Nr4^5*r^4 + 162*Nr4^5*r^2 + 166*Nr4^5 - 63*Nr4^4*r^4 - 206*Nr4^4*r^2 - 148*Nr4^4 + 8*Nr4^3*r^6 + 87*Nr4^3*r^4 + 170*Nr4^3*r^2 + 91*Nr4^3 - 16*Nr4^2*r^6 - 69*Nr4^2*r^4 - 90*Nr4^2*r^2 - 37*Nr4^2 + Nr4*r^8 + 12*Nr4*r^6 + 30*Nr4*r^4 + 28*Nr4*r^2 + 9*Nr4 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr4^10 + 15*Nr4^8*r^2 - 40*Nr4^7*r^2 + 35*Nr4^6*r^4 + 80*Nr4^6*r^2 - 84*Nr4^5*r^4 - 108*Nr4^5*r^2 + 28*Nr4^4*r^6 + 126*Nr4^4*r^4 + 103*Nr4^4*r^2 - 48*Nr4^3*r^6 - 116*Nr4^3*r^4 - 68*Nr4^3*r^2 + 9*Nr4^2*r^8 + 48*Nr4^2*r^6 + 69*Nr4^2*r^4 + 30*Nr4^2*r^2 - 8*Nr4*r^8 - 24*Nr4*r^6 - 24*Nr4*r^4 - 8*Nr4*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
	K5=r*(5*Nr5^9 - 25*Nr5^8 + 20*Nr5^7*r^2 + 70*Nr5^7 - 80*Nr5^6*r^2 - 130*Nr5^6 + 21*Nr5^5*r^4 + 162*Nr5^5*r^2 + 166*Nr5^5 - 63*Nr5^4*r^4 - 206*Nr5^4*r^2 - 148*Nr5^4 + 8*Nr5^3*r^6 + 87*Nr5^3*r^4 + 170*Nr5^3*r^2 + 91*Nr5^3 - 16*Nr5^2*r^6 - 69*Nr5^2*r^4 - 90*Nr5^2*r^2 - 37*Nr5^2 + Nr5*r^8 + 12*Nr5*r^6 + 30*Nr5*r^4 + 28*Nr5*r^2 + 9*Nr5 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr5^10 + 15*Nr5^8*r^2 - 40*Nr5^7*r^2 + 35*Nr5^6*r^4 + 80*Nr5^6*r^2 - 84*Nr5^5*r^4 - 108*Nr5^5*r^2 + 28*Nr5^4*r^6 + 126*Nr5^4*r^4 + 103*Nr5^4*r^2 - 48*Nr5^3*r^6 - 116*Nr5^3*r^4 - 68*Nr5^3*r^2 + 9*Nr5^2*r^8 + 48*Nr5^2*r^6 + 69*Nr5^2*r^4 + 30*Nr5^2*r^2 - 8*Nr5*r^8 - 24*Nr5*r^6 - 24*Nr5*r^4 - 8*Nr5*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
	K6=r*(5*Nr6^9 - 25*Nr6^8 + 20*Nr6^7*r^2 + 70*Nr6^7 - 80*Nr6^6*r^2 - 130*Nr6^6 + 21*Nr6^5*r^4 + 162*Nr6^5*r^2 + 166*Nr6^5 - 63*Nr6^4*r^4 - 206*Nr6^4*r^2 - 148*Nr6^4 + 8*Nr6^3*r^6 + 87*Nr6^3*r^4 + 170*Nr6^3*r^2 + 91*Nr6^3 - 16*Nr6^2*r^6 - 69*Nr6^2*r^4 - 90*Nr6^2*r^2 - 37*Nr6^2 + Nr6*r^8 + 12*Nr6*r^6 + 30*Nr6*r^4 + 28*Nr6*r^2 + 9*Nr6 - r^8 - 4*r^6 - 6*r^4 - 4*r^2 - 1)/(Nr6^10 + 15*Nr6^8*r^2 - 40*Nr6^7*r^2 + 35*Nr6^6*r^4 + 80*Nr6^6*r^2 - 84*Nr6^5*r^4 - 108*Nr6^5*r^2 + 28*Nr6^4*r^6 + 126*Nr6^4*r^4 + 103*Nr6^4*r^2 - 48*Nr6^3*r^6 - 116*Nr6^3*r^4 - 68*Nr6^3*r^2 + 9*Nr6^2*r^8 + 48*Nr6^2*r^6 + 69*Nr6^2*r^4 + 30*Nr6^2*r^2 - 8*Nr6*r^8 - 24*Nr6*r^6 - 24*Nr6*r^4 - 8*Nr6*r^2 + r^10 + 4*r^8 + 6*r^6 + 4*r^4 + r^2);
		
    ut(1)=-ek(1)*K1;
    ut(2)=-ek(2)*K2;
    ut(3)=-ek(3)*K3;
    ut(4)=-ek(4)*K4;
    ut(5)=-ek(5)*K5;
    ut(6)=-ek(6)*K6;

    %é‡‡ç”¨ä¼˜åŒ–å¾—åˆ°çš„MPCæ§åˆ¶é‡utçš„ç¬¬ä¸?¸ªå…ƒç´ ä½œä¸ºç¬¬äºŒè‰²å®é™…ä½œç”¨çš„MPCæ§åˆ¶é‡ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä½œä¸ºç¬¬ä¸‰è‰²å®é™…ä½œç”¨çš„MPCæ§åˆ¶é‡ï¼Œ
    %åˆ†åˆ«æ ¹æ®å¾—åˆ°MPCæ§åˆ¶é‡ç®—å‡ºå®é™…æ§åˆ¶é‡ï¼ˆè¡¥å¿é‡+MPCæ§åˆ¶é‡ï¼‰
    %å°†å®é™…æ§åˆ¶é‡ä»£å…¥å®é™…ç³»ç»Ÿå¾—åˆ°å®é™…è¯¯å·®
    %å†å°†å®é™…è¯¯å·®ç»§ç»­äºŒæ¬¡ä¼˜åŒ–å‡ºä¸‹ä¸?—¶åˆ»çš„MPCæ§åˆ¶é‡ut
    u21(k)=ut(1);%ç¬¬äºŒè‰²MPCæ§åˆ¶é‡?
    u31(k)=ut(2);%ç¬¬ä¸‰è‰²MPCæ§åˆ¶é‡?
    u41(k)=ut(3);
    u51(k)=ut(4);
    u61(k)=ut(5);
    u71(k)=ut(6);
    

    w2(k)=(u21(k)-u21(k-1));%ç¬¬äºŒè‰²åŸæœ¬çš„MPCæ§åˆ¶é‡ï¼ˆä¸åŠ ç§¯åˆ†ï¼?
    w3(k)=(u31(k)-u31(k-1));%ç¬¬ä¸‰è‰²åŸæœ¬çš„MPCæ§åˆ¶é‡ï¼ˆä¸åŠ ç§¯åˆ†ï¼?
    w4(k)=(u41(k)-u41(k-1));
    w5(k)=(u51(k)-u51(k-1));
    w6(k)=(u61(k)-u61(k-1));
    w7(k)=(u71(k)-u71(k-1));
    
    u2b(k)=(1-1/Nr1)*u2b(k-1)+w2(k)-w2(k-1);%å¯¹ç¬¬äºŒè‰²è¡¥å¿é‡è®¡ç®?
    u3b(k)=(1-1/Nr2)*u3b(k-1)+w3(k)-w3(k-1);
    u4b(k)=(1-1/Nr3)*u4b(k-1)+w4(k)-w4(k-1);
    u5b(k)=(1-1/Nr4)*u5b(k-1)+w5(k)-w5(k-1);
    u6b(k)=(1-1/Nr5)*u6b(k-1)+w6(k)-w6(k-1);
    
    u2(k)=w2(k);%ç¬¬äºŒè‰²å®é™…æ§åˆ¶é‡
    u3(k)=w3(k)+u2b(k);%ç¬¬ä¸‰è‰²å®é™…æ§åˆ¶é‡
    u4(k)=w4(k)+u2b(k)+u3b(k);
    u5(k)=w5(k)+u2b(k)+u3b(k)+u4b(k);
    u6(k)=w6(k)+u2b(k)+u3b(k)+u4b(k)+u5b(k);
    u7(k)=w7(k)+u2b(k)+u3b(k)+u4b(k)+u5b(k)+u6b(k);
    
%     u3=lsim(U,u31(1:k),t)+lsim(U2,u2(1:k),t);%ç¬¬ä¸‰è‰²å®é™…æ§åˆ¶é‡
%     u4=lsim(U,u41(1:k),t)+lsim(U2,u2(1:k),t)+lsim(U3,u31(1:k),t);%ç¬¬å››è‰²å®é™…æ§åˆ¶é‡
%     u5=lsim(U,u51(1:k),t)+lsim(U2,u2(1:k),t)+lsim(U3,u31(1:k),t)+lsim(U4,u41(1:k),t);
%     u6=lsim(U,u61(1:k),t)+lsim(U2,u2(1:k),t)+lsim(U3,u31(1:k),t)+lsim(U4,u41(1:k),t)+lsim(U5,u51(1:k),t);
%     u7=lsim(U,u71(1:k),t)+lsim(U2,u2(1:k),t)+lsim(U3,u31(1:k),t)+lsim(U4,u41(1:k),t)+lsim(U5,u51(1:k),t)+lsim(U6,u61(1:k),t);
    
%     e2=lsim(G2,u2(1:k),t,x0);

%     e2(k)=(2-1/Nr1)*e2(k-1)+(1/Nr1-1)*e2(k-2)+r*Ts/Nr1*u2(k-2);%ç®—å‡ºç¬¬äºŒè‰²çš„å®é™…è¯¯å·®é‡?
%     e3=lsim(G3,u3(1:k),t)+lsim(G321,u2(1:k),t)-lsim(G322,u2(1:k),t);%ç®—å‡ºç¬¬ä¸‰è‰²çš„å®é™…è¯¯å·®é‡?
%     e4=lsim(G4,u4(1:k),t)+lsim(G421,u2(1:k),t)-lsim(G422,u2(1:k),t)+lsim(G431,u3(1:k),t)-lsim(G432,u3(1:k),t);
%     e5=lsim(G5,u5(1:k),t)+lsim(G521,u2(1:k),t)-lsim(G522,u2(1:k),t)+lsim(G531,u3(1:k),t)-lsim(G532,u3(1:k),t)+lsim(G541,u4(1:k),t)-lsim(G542,u4(1:k),t);
%     e6=lsim(G6,u6(1:k),t)+lsim(G621,u2(1:k),t)-lsim(G622,u2(1:k),t)+lsim(G631,u3(1:k),t)-lsim(G632,u3(1:k),t)+lsim(G641,u4(1:k),t)-lsim(G642,u4(1:k),t)+lsim(G651,u5(1:k),t)-lsim(G652,u5(1:k),t);
%     e7=lsim(G7,u7(1:k),t)+lsim(G721,u2(1:k),t)-lsim(G722,u2(1:k),t)+lsim(G731,u3(1:k),t)-lsim(G732,u3(1:k),t)+lsim(G741,u4(1:k),t)-lsim(G742,u4(1:k),t)+lsim(G751,u5(1:k),t)-lsim(G752,u5(1:k),t)+lsim(G761,u6(1:k),t)-lsim(G762,u6(1:k),t);



    e2(k)=(1-1/Nr1)*e2(k-1)+r/Nr1*u2(k-1);%ç®—å‡ºç¬¬äºŒè‰²çš„å®é™…è¯¯å·®é‡? 
    e3=lsim(G3,u3(1:k),t)+lsim(G321,u2(1:k),t)-lsim(G322,u2(1:k),t);%ç®—å‡ºç¬¬ä¸‰è‰²çš„å®é™…è¯¯å·®é‡?
    e4=lsim(G4,u4(1:k),t)+lsim(G421,u2(1:k),t)-lsim(G422,u2(1:k),t)+lsim(G431,u3(1:k),t)-lsim(G432,u3(1:k),t);
    e5=lsim(G5,u5(1:k),t)+lsim(G521,u2(1:k),t)-lsim(G522,u2(1:k),t)+lsim(G531,u3(1:k),t)-lsim(G532,u3(1:k),t)+lsim(G541,u4(1:k),t)-lsim(G542,u4(1:k),t);
    e6=lsim(G6,u6(1:k),t)+lsim(G621,u2(1:k),t)-lsim(G622,u2(1:k),t)+lsim(G631,u3(1:k),t)-lsim(G632,u3(1:k),t)+lsim(G641,u4(1:k),t)-lsim(G642,u4(1:k),t)+lsim(G651,u5(1:k),t)-lsim(G652,u5(1:k),t);
    e7=lsim(G7,u7(1:k),t)+lsim(G721,u2(1:k),t)-lsim(G722,u2(1:k),t)+lsim(G731,u3(1:k),t)-lsim(G732,u3(1:k),t)+lsim(G741,u4(1:k),t)-lsim(G742,u4(1:k),t)+lsim(G751,u5(1:k),t)-lsim(G752,u5(1:k),t)+lsim(G761,u6(1:k),t)-lsim(G762,u6(1:k),t);
    ek=[e2(k);e3(k);e4(k);e5(k);e6(k);e7(k)];
    %å¯¹ä¼˜åŒ–åˆå§‹å?è¿›è¡Œä¿®æ”¹ï¼Œé‡‡ç”¨é¢„æµ‹å?çš„åæ®µä½œä¸ºä¸‹ä¸?­¥çš„åˆå§‹å?
%     u0=[ut(7:6*Np);ut(6*Np);ut(6*Np);ut(6*Np);ut(6*Np);ut(6*Np);ut(6*Np)];
    
end


plot(e2(1,2:200),'LineWidth',2,'DisplayName','E2å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
hold all
plot(e3(2:200,1),'LineWidth',2,'DisplayName','E3å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
plot(e4(2:200,1),'LineWidth',2,'DisplayName','E4å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
plot(e5(2:200,1),'LineWidth',2,'DisplayName','E5å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
plot(e6(2:200,1),'LineWidth',2,'DisplayName','E6å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
plot(e7(2:200,1),'LineWidth',2,'DisplayName','E7å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% xlabel('è½?);
% ylabel('è¯¯å·®ï¼?.01mm)');


% plot(u2(1,3:200),'LineWidth',2,'DisplayName','u2å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% hold all
% plot(u3(1,3:200),'LineWidth',2,'DisplayName','u3å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% plot(u4(1,3:200),'LineWidth',2,'DisplayName','u4å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% plot(u5(1,3:200),'LineWidth',2,'DisplayName','u5å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% plot(u6(1,3:200),'LineWidth',2,'DisplayName','u6å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% plot(u7(1,3:200),'LineWidth',2,'DisplayName','u7å®Œå…¨è§£è?æ¨¡å‹é¢„æµ‹æ§åˆ¶');
% xlabel('è½?);
% ylabel('æ§åˆ¶é‡ï¼ˆ0.01mm)');

toc%è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨è®¡ç®—æ­¤æ—¶ä¸æœ?¿‘ä¸?¬¡ticä¹‹é—´çš„æ—¶é—?